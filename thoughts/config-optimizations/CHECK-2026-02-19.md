# Config Optimization Report - 2026-02-19

## Current Version: 2.1.47
## Last Checked: 2.1.37 (2026-02-08)
## New Versions: 2.1.38, 2.1.39, 2.1.41, 2.1.42, 2.1.44, 2.1.45, 2.1.47 (7 releases)

---

## Release Highlights (2.1.38 → 2.1.47)

### v2.1.47 (Feb 18) — Major Release
- **`last_assistant_message`** in Stop/SubagentStop hook inputs (no transcript parsing needed)
- **`chat:newline`** keybinding action for configurable multi-line input
- **`added_dirs`** in statusline JSON workspace section
- **`ctrl+f`** to kill all background agents (replaces double-ESC)
- **Deferred SessionStart hooks** — ~500ms startup improvement
- **Fixed**: Custom agent `model` field now works when spawning teammates
- **Fixed**: Teammate spinners respect `spinnerVerbs`
- **Fixed**: Plugin agent skills load by bare name (not just fully-qualified)
- **Fixed**: Agents/skills discovered from git worktrees
- **Fixed**: Unicode curly quote corruption in Edit tool
- **Fixed**: CJK wide character alignment in TUI

### v2.1.45 (Feb 17)
- **Claude Sonnet 4.6** model support
- **`spinnerTipsOverride`** setting: custom tips array + `excludeDefault` option
- **Plugin config from `--add-dir`** directories
- **Fixed**: Plugin commands/agents/hooks available immediately after install (no restart)
- **Fixed**: Skills from subagents no longer leak into main session after compaction

### v2.1.41 (Feb 13)
- **`claude auth login/status/logout`** CLI subcommands
- **`/rename`** auto-generates session names from conversation context
- **Fixed**: AWS auth refresh timeout (was hanging indefinitely)

### v2.1.38 (Feb 10)
- **Sandbox**: Blocked writes to `.claude/skills` directory
- **Security**: Improved heredoc delimiter parsing (anti-smuggling)

---

## New Features from Documentation Deep Dive

### P0 - High Value (Apply Now)

#### 1. `CLAUDE_CODE_MAX_OUTPUT_TOKENS` env var
**Status**: Not set (default 32000)
**What**: Max output tokens per response, up to 64000.
**Value**: Prevents truncated outputs for complex code generation tasks.
**Risk**: None — only increases capacity when needed.
```json
"env": { "CLAUDE_CODE_MAX_OUTPUT_TOKENS": "64000" }
```

#### 2. `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE` env var
**Status**: Not set (default ~95%)
**What**: Override auto-compaction threshold.
**Value**: Set to 85 to align with context-budget.md rules (85% = danger zone).
**Risk**: Low — earlier compaction preserves quality.
```json
"env": { "CLAUDE_AUTOCOMPACT_PCT_OVERRIDE": "85" }
```

#### 3. Hook `statusMessage` field
**Status**: Not used
**What**: Custom spinner message during hook execution.
**Value**: Users see "Checking code style..." instead of generic spinner.
**Risk**: None — purely cosmetic improvement.
```json
{ "type": "command", "command": "...", "statusMessage": "Running code review..." }
```

#### 4. `last_assistant_message` in Stop/SubagentStop (v2.1.47)
**Status**: Available but hooks may not use it yet
**What**: Final response text in hook input — no need to parse transcript.
**Value**: Simplify `subagent-stop.sh` and `stop.sh` hooks.

### P1 - Medium Value (Consider)

#### 5. `PostToolUseFailure` Hook Event
**Status**: Not configured
**What**: Fires when a tool call fails. Receives `error` and `is_interrupt`.
**Value**: Better failure logging, corrective feedback to Claude.
```json
"PostToolUseFailure": [{
  "matcher": "Bash",
  "hooks": [{ "type": "command", "command": "$HOME/.claude/hooks/post-tool-use-failure.sh" }]
}]
```

#### 6. Prompt-based Hooks (`type: "prompt"`)
**Status**: Not used
**What**: LLM-evaluated hook decisions instead of bash scripts.
**Supported**: PreToolUse, PostToolUse, PostToolUseFailure, PermissionRequest, UserPromptSubmit, Stop, SubagentStop, TaskCompleted
**Value**: Could replace complex bash logic in quality gates.
```json
{ "type": "prompt", "prompt": "Evaluate task completion: $ARGUMENTS", "timeout": 30 }
```

#### 7. Agent-based Hooks (`type: "agent"`)
**Status**: Not used
**What**: Multi-turn subagent hooks (Read/Grep/Glob, up to 50 turns).
**Value**: Verify files, test results, code quality before Stop/TaskCompleted.
```json
{ "type": "agent", "prompt": "Verify tests pass: $ARGUMENTS", "timeout": 120 }
```

#### 8. Async Hooks (`async: true`)
**Status**: Not used
**What**: Background execution, results on next turn.
**Value**: Non-blocking test runners, deployment scripts.
```json
{ "type": "command", "command": "...", "async": true, "timeout": 120 }
```

#### 9. `MAX_MCP_OUTPUT_TOKENS` env var
**Status**: Not set (default 25000)
**What**: Max tokens for MCP tool output.
**Value**: Prevents truncation of large MCP responses.
```json
"env": { "MAX_MCP_OUTPUT_TOKENS": "40000" }
```

#### 10. `spinnerTipsOverride` setting (v2.1.45)
**Status**: Not configured
**What**: Custom tips array shown during spinner.
**Value**: Could show plugin-specific tips or workflow reminders.

#### 11. `SubagentStart` Hook Event
**Status**: Not configured
**What**: Fires when subagent spawns. Can inject `additionalContext`.
**Value**: Auto-inject project context into every subagent.

### P2 - Informational / Low Priority

| Feature | Since | Notes |
|---------|-------|-------|
| Chrome Integration (Beta) | docs | `claude --chrome` or `/chrome` |
| Claude Code on Web | docs | `&` prefix, `--remote`, `/teleport` |
| Desktop App | docs | GUI with diffs, parallel sessions |
| Checkpointing | docs | `Esc+Esc` or `/rewind` |
| Output Styles | docs | Custom system prompt via `.claude/output-styles/` |
| `CLAUDE_CODE_EFFORT_LEVEL` | docs | `low/medium/high` for Opus 4.6 |
| `claude auth` subcommands | v2.1.41 | `login/status/logout` |
| Sonnet 4.6 model | v2.1.45 | Available in model selection |
| `ENABLE_TOOL_SEARCH` | docs | MCP tool search control |
| Hook `once` field | docs | Run once per session (skills only) |

---

## Already Optimized (previous checks)

- [x] Agent teams experimental flag
- [x] Plugin commit SHA pinning
- [x] StatusLine with cost/delta
- [x] Task management v2.1.16
- [x] Skill description patterns
- [x] Memory frontmatter
- [x] TeammateIdle + TaskCompleted hooks
- [x] Attribution (empty = no AI)

---

## Recommended Actions

### Apply Now (No Risk)

| # | Optimization | Impact | Effort |
|---|-------------|--------|--------|
| 1 | `CLAUDE_CODE_MAX_OUTPUT_TOKENS=64000` | Prevent truncated outputs | 1 line |
| 2 | `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE=85` | Earlier compaction | 1 line |
| 3 | `statusMessage` on long hooks | Better UX | Edit existing hooks |
| 4 | Use `last_assistant_message` in hooks | Simplify hook scripts | Update scripts |

### Consider (Need Evaluation)

| # | Optimization | Requires |
|---|-------------|----------|
| 5 | PostToolUseFailure hook | Write new hook script |
| 6-7 | Prompt/Agent hooks | Evaluate replacing bash hooks |
| 8 | Async hooks for tests | Identify async-safe candidates |
| 9 | MAX_MCP_OUTPUT_TOKENS | Check if outputs are truncated |
| 11 | SubagentStart context injection | Write injection hook |

### Skip (Not Needed Now)

| # | Optimization | Reason |
|---|-------------|--------|
| CLAUDE_CODE_EFFORT_LEVEL | Default is correct for Opus |
| Output Styles | CLAUDE.md + rules sufficient |
| Chrome/Web/Desktop | Informational, not config |

---

## Bug Fixes Relevant to Plugins

| Version | Fix | Impact on claude-plugins |
|---------|-----|-------------------------|
| v2.1.47 | Agent `model` field works for teammates | Our agents' model settings now effective |
| v2.1.47 | Plugin agent skills load by bare name | Simpler agent references in skills |
| v2.1.47 | Skills discovered from git worktrees | Desktop worktree users benefit |
| v2.1.45 | Plugins available immediately after install | Better install UX |
| v2.1.45 | Skills from subagents don't leak after compact | Prevents context pollution |
| v2.1.47 | Unicode curly quote preserved in Edit | Content fidelity improvement |
