# Local Mode (No External Dependencies)

When Braintrust is unavailable (missing Python modules, API issues, network), use local data sources.

## Quick Check

```bash
# Test Braintrust availability
uv run python -c "import requests" 2>/dev/null && echo "BRAINTRUST_OK" || echo "LOCAL_MODE"
```

## Local Data Sources (Priority Order)

| Source | Location | Quality | Contains |
|--------|----------|---------|----------|
| **Insights facets** | `~/.claude/usage-data/facets/*.json` | **High** | Goals, friction, outcomes (structured) |
| **Insights report** | `~/.claude/usage-data/report.html` | **High** | Aggregated analysis, CLAUDE.md suggestions |
| Session JSONL | `~/.claude/projects/<proj>/*.jsonl` | Medium | Full transcripts |
| Session index | `~/.claude/projects/<proj>/session-index` | Low | Metadata |
| Stats cache | `~/.claude/projects/<proj>/stats-cache` | Low | Token usage |
| Commit reasoning | `.git/claude/commits/*/reasoning.md` | Medium | Decisions |
| Ledgers | `thoughts/ledgers/` | Medium | Task completion |

## Insights Facets (Recommended)

Facets are generated by Claude Code after each session. Each file is a structured JSON:

```json
{
  "underlying_goal": "Implement auth feature",
  "goal_categories": { "feature_implementation": 1 },
  "outcome": "fully_achieved",
  "friction_counts": { "wrong_approach": 1 },
  "friction_detail": "Description of what went wrong",
  "primary_success": "multi_file_changes",
  "session_id": "abc-123"
}
```

**Extraction:**
```bash
# Count all sessions
ls ~/.claude/usage-data/facets/*.json | wc -l

# Find friction events
jq -s '[.[] | select(.friction_counts != {})]' ~/.claude/usage-data/facets/*.json

# Aggregate goal categories
jq -s '[.[].goal_categories] | add' ~/.claude/usage-data/facets/*.json

# Get recent N sessions (by modification time)
ls -t ~/.claude/usage-data/facets/*.json | head -10 | xargs jq -s '.'
```

**Workflow:**
```
/insights → generates report.html
/meta-iterate           → insights + evaluate 合并 (完整)
/meta-iterate insights  → 仅 facets + report (无需 Braintrust)
```

## Local JSONL Workflow (Fallback)

```
[local evaluate] -> diagnose -> propose -> [approve] -> apply -> verify
```

The evaluate phase uses local session JSONL files instead of Braintrust API.
Mark evaluation with `data_quality: "local"` to indicate limited data fidelity.

## Troubleshooting

| Issue | Solution |
|-------|----------|
| No facets files | Run a few sessions first, facets auto-generate |
| `requests module not installed` | Use `insights` mode OR run `uv pip install requests` |
| `aiohttp not found` | Use `insights` mode OR run `uv pip install aiohttp` |
| Braintrust API timeout | Use `insights` mode (local files, no network) |
| Empty evaluation results | Check `~/.claude/usage-data/facets/` for session files |

**Tip**: `insights` mode provides ~90% of evaluation quality with zero external dependencies.
